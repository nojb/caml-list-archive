Return-Path: <kennethadammiller@gmail.com>
X-Original-To: caml-list@sympa.inria.fr
Delivered-To: caml-list@sympa.inria.fr
Received: from mail2-relais-roc.national.inria.fr (mail2-relais-roc.national.inria.fr [192.134.164.83])
	by sympa.inria.fr (Postfix) with ESMTPS id 4CEB97FC86
	for <caml-list@sympa.inria.fr>; Thu, 19 Mar 2015 20:33:43 +0100 (CET)
Received-SPF: None (mail2-smtp-roc.national.inria.fr: no sender
  authenticity information available from domain of
  kennethadammiller@gmail.com) identity=pra;
  client-ip=209.85.214.178;
  receiver=mail2-smtp-roc.national.inria.fr;
  envelope-from="kennethadammiller@gmail.com";
  x-sender="kennethadammiller@gmail.com";
  x-conformance=sidf_compatible
Received-SPF: Pass (mail2-smtp-roc.national.inria.fr: domain of
  kennethadammiller@gmail.com designates 209.85.214.178 as
  permitted sender) identity=mailfrom;
  client-ip=209.85.214.178;
  receiver=mail2-smtp-roc.national.inria.fr;
  envelope-from="kennethadammiller@gmail.com";
  x-sender="kennethadammiller@gmail.com";
  x-conformance=sidf_compatible; x-record-type="v=spf1"
Received-SPF: None (mail2-smtp-roc.national.inria.fr: no sender
  authenticity information available from domain of
  postmaster@mail-ob0-f178.google.com) identity=helo;
  client-ip=209.85.214.178;
  receiver=mail2-smtp-roc.national.inria.fr;
  envelope-from="kennethadammiller@gmail.com";
  x-sender="postmaster@mail-ob0-f178.google.com";
  x-conformance=sidf_compatible
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: A0BuAADLIwtVm7LWVdFcg1haBIMJwxqFfQKBPgdMAQEBAQEBEQEBAQEBBgsLCRQuhA8BAQEDARIRHQEbHgMBCwYFCw0qAgIhAQERAQUBHAYTIod4AQMJCKYTPjGLMYFrgneRIAoZJw1UhFUBAQgBAQEBGAEFDosJgkSCNIJogUUFlDqEM4FMgRs6i2FMgl+BfRIjgQwJgiQcgWwiMYJDAQEB
X-IPAS-Result: A0BuAADLIwtVm7LWVdFcg1haBIMJwxqFfQKBPgdMAQEBAQEBEQEBAQEBBgsLCRQuhA8BAQEDARIRHQEbHgMBCwYFCw0qAgIhAQERAQUBHAYTIod4AQMJCKYTPjGLMYFrgneRIAoZJw1UhFUBAQgBAQEBGAEFDosJgkSCNIJogUUFlDqEM4FMgRs6i2FMgl+BfRIjgQwJgiQcgWwiMYJDAQEB
X-IronPort-AV: E=Sophos;i="5.11,431,1422918000"; 
   d="scan'208";a="126816484"
Received: from mail-ob0-f178.google.com ([209.85.214.178])
  by mail2-smtp-roc.national.inria.fr with ESMTP/TLS/RC4-SHA; 19 Mar 2015 20:33:42 +0100
Received: by obcjt1 with SMTP id jt1so42346799obc.2
        for <caml-list@inria.fr>; Thu, 19 Mar 2015 12:33:41 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20120113;
        h=mime-version:in-reply-to:references:date:message-id:subject:from:to
         :content-type;
        bh=EJ1xyAlbY2mwK9iliMTGJqOKz8gxQUblpjFDQlTfujo=;
        b=eJ3hXaMf4zkQ4jshkPYLa39djWNBrdgknpO5CDr07L8oNIth/JrJoV+okdRD6a6Z06
         VaC9TITA1AWvEpOP5FbqFBYMxWPiL1ugS0JqvMk5KnleX43E18V1UqIbio4DAzZWnGrC
         9mBNt6GSiwAHJVh9hvE0vB+n2rbToizkuVA43rSeHyNwA4YOPXu3+wph2iknuRxjqSUe
         rmUJ9KWG3ghvyHpzahxswfejo8AXJIYKZK0PFKZJf0n6T1aIsPyM6cBQNcRpkabc1QWk
         JTHspxnBw1OTMM9A1SL8zrmhqy2ztLudpQe3rEMxhGxHq5odPRdLhqnbFHO7CfTdDrhL
         m0Fw==
MIME-Version: 1.0
X-Received: by 10.60.124.42 with SMTP id mf10mr35498025oeb.81.1426793621030;
 Thu, 19 Mar 2015 12:33:41 -0700 (PDT)
Received: by 10.202.185.8 with HTTP; Thu, 19 Mar 2015 12:33:40 -0700 (PDT)
In-Reply-To: <CANhEzE6uSa8JF6mg3NBjrEh8A4c2oBn_mzTZjcRW4_QtVJRxyQ@mail.gmail.com>
References: <CAK7rcp91SmNb5vNZMNzE2xGr+WCvwXUFqOwzq7t1c_RbaAo9OQ@mail.gmail.com>
	<CANhEzE6uSa8JF6mg3NBjrEh8A4c2oBn_mzTZjcRW4_QtVJRxyQ@mail.gmail.com>
Date: Thu, 19 Mar 2015 15:33:40 -0400
Message-ID: <CAK7rcp837bzcG6w1xOuRQvpn4VwF_DshdK28-TbkgFTyO4t8Yw@mail.gmail.com>
From: Kenneth Adam Miller <kennethadammiller@gmail.com>
To: caml users <caml-list@inria.fr>
Content-Type: multipart/alternative; boundary=047d7b5d483cf30de90511a94660
Subject: Re: [Caml-list] Utop Difficulties with C callbacks

--047d7b5d483cf30de90511a94660
Content-Type: text/plain; charset=UTF-8

Thanks! I appreciate this so much!

Gah, I skipped sleep in my determination to fix this.

I will hit it with -dllib iteration. I love oasis, and I'm an avid user.
Piqi doesn't use oasis :( sadness.

It does, however, already do the -custom approach, but only when compiling
the cma (I differentiate you said when building the executable). So I don't
know why it wouldn't work with that. In any case, I will take your advice
about the proper route. I'm all about quality and doing things right!

On Thu, Mar 19, 2015 at 3:01 PM, Jeremie Dimino <jdimino@janestreet.com>
wrote:

> I have to run, but think the problem is that piqilib is not building a
> shared library for its C stubs: if you want to be able to load a
> library with C stubs in the toplevel, the stubs must be packed into a
> shared library. You normally do this with ocamlmklib and pass a -dllib
> option when building the .cma. oasis does all that automatically.
>
> This other option is to build the bytecode executable with -custom,
> which will link the C libraries, the ocamlrun executable and the
> bytecode into a single native executable.
>
> So simply adding -custom when building a custom utop should work. But
> the proper fix is to update piqilib to build a .so for its C stubs.
>
>
>
> On Thu, Mar 19, 2015 at 6:19 PM, Kenneth Adam Miller
> <kennethadammiller@gmail.com> wrote:
> > So, I've been working for a while with a library and I've made a good
> > iteration. My code compiles and is nice, it does what is expected, but it
> > depends on a library, Piqi, that doesn't want to play nice in the
> > interpreter. I want to be a good citizen and do my homework and due
> > diligence, but nothing I do seems to make utop want to play nice with
> piqi.
> >
> > Here goes:
> >
> > When I execute utop -require mypackage repository with the newly built
> > package mypackage, but I get this error:
> >
> > File "_none_", line 1:
> > Error: The external function `camlidl_piqi_c_piqi_strtoull' is not
> available
> >
> > I checked out piqi locally, and pinned the package to my local build,
> where
> > I tried to ensure that the appropriate .c file is getting compiled and
> > linked into the cma and cmxa. They are without a shadow of a doubt. I
> then
> > thought maybe I would add an include directive to utop to tell it to
> pick up
> > the mli where the the external func : type = "name" is. Nope.
> >
> > I've done everything I can, from adding all combinations of additional
> > piqirun/piqilib/piqirun.pb/piqirun.ext combinations to the _oasis file
> that
> > specifies the serialization to trying to build my own utop to adding
> > additional require statements and include statements in the utop script.
> So
> > after trying to add the dependency to BuildDepends for myouterlib, I had
> > backed off to just adding the mylibrary to the specific binary that
> consumes
> > it, which is where my changes are (in that binary).
> >
> > I even went so far as to just try and get the changes compiled into a
> custom
> > utop. Nope. I got errors and errors; I built it with:
> > ocamlbuild -use-ocamlfind -pkg threads -pkg utop -pkg myouterlib -pkg
> camlp4
> > -pkg core_kernel customtop.top
> >
> > (At the time I ran this, I had bap package's _oasis updated with the
> > appropriate compile BuildDepends so that it would link mylibrary too)
> >
> > and I had the let () = Utop_main.main ();; in "utopmain.ml" and
> customary
> > customtop.mltop containing just "Utopmain". I got:
> >
> > (Unbound value <everything I need *and* that's contained in mylibrary
> which
> > is specified in -pkg!>)
> >
> > I don't know what else to do besides ship code that is watered down
> without
> > an interactive component. :/
>
>
>
> --
> Jeremie
>

--047d7b5d483cf30de90511a94660
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr">Thanks! I appreciate this so much!=C2=A0<div><br></div><di=
v>Gah, I skipped sleep in my determination to fix this.</div><div><br></div=
><div>I will hit it with -dllib iteration. I love oasis, and I&#39;m an avi=
d user. Piqi doesn&#39;t use oasis :( sadness.</div><div><br></div><div>It =
does, however, already do the -custom approach, but only when compiling the=
 cma (I differentiate you said when building the executable). So I don&#39;=
t know why it wouldn&#39;t work with that. In any case, I will take your ad=
vice about the proper route. I&#39;m all about quality and doing things rig=
ht!</div></div><div class=3D"gmail_extra"><br><div class=3D"gmail_quote">On=
 Thu, Mar 19, 2015 at 3:01 PM, Jeremie Dimino <span dir=3D"ltr">&lt;<a href=
=3D"mailto:jdimino@janestreet.com" target=3D"_blank">jdimino@janestreet.com=
</a>&gt;</span> wrote:<br><blockquote class=3D"gmail_quote" style=3D"margin=
:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">I have to run, but=
 think the problem is that piqilib is not building a<br>
shared library for its C stubs: if you want to be able to load a<br>
library with C stubs in the toplevel, the stubs must be packed into a<br>
shared library. You normally do this with ocamlmklib and pass a -dllib<br>
option when building the .cma. oasis does all that automatically.<br>
<br>
This other option is to build the bytecode executable with -custom,<br>
which will link the C libraries, the ocamlrun executable and the<br>
bytecode into a single native executable.<br>
<br>
So simply adding -custom when building a custom utop should work. But<br>
the proper fix is to update piqilib to build a .so for its C stubs.<br>
<div class=3D"HOEnZb"><div class=3D"h5"><br>
<br>
<br>
On Thu, Mar 19, 2015 at 6:19 PM, Kenneth Adam Miller<br>
&lt;<a href=3D"mailto:kennethadammiller@gmail.com">kennethadammiller@gmail.=
com</a>&gt; wrote:<br>
&gt; So, I&#39;ve been working for a while with a library and I&#39;ve made=
 a good<br>
&gt; iteration. My code compiles and is nice, it does what is expected, but=
 it<br>
&gt; depends on a library, Piqi, that doesn&#39;t want to play nice in the<=
br>
&gt; interpreter. I want to be a good citizen and do my homework and due<br>
&gt; diligence, but nothing I do seems to make utop want to play nice with =
piqi.<br>
&gt;<br>
&gt; Here goes:<br>
&gt;<br>
&gt; When I execute utop -require mypackage repository with the newly built=
<br>
&gt; package mypackage, but I get this error:<br>
&gt;<br>
&gt; File &quot;_none_&quot;, line 1:<br>
&gt; Error: The external function `camlidl_piqi_c_piqi_strtoull&#39; is not=
 available<br>
&gt;<br>
&gt; I checked out piqi locally, and pinned the package to my local build, =
where<br>
&gt; I tried to ensure that the appropriate .c file is getting compiled and=
<br>
&gt; linked into the cma and cmxa. They are without a shadow of a doubt. I =
then<br>
&gt; thought maybe I would add an include directive to utop to tell it to p=
ick up<br>
&gt; the mli where the the external func : type =3D &quot;name&quot; is. No=
pe.<br>
&gt;<br>
&gt; I&#39;ve done everything I can, from adding all combinations of additi=
onal<br>
&gt; piqirun/piqilib/piqirun.pb/piqirun.ext combinations to the _oasis file=
 that<br>
&gt; specifies the serialization to trying to build my own utop to adding<b=
r>
&gt; additional require statements and include statements in the utop scrip=
t. So<br>
&gt; after trying to add the dependency to BuildDepends for myouterlib, I h=
ad<br>
&gt; backed off to just adding the mylibrary to the specific binary that co=
nsumes<br>
&gt; it, which is where my changes are (in that binary).<br>
&gt;<br>
&gt; I even went so far as to just try and get the changes compiled into a =
custom<br>
&gt; utop. Nope. I got errors and errors; I built it with:<br>
&gt; ocamlbuild -use-ocamlfind -pkg threads -pkg utop -pkg myouterlib -pkg =
camlp4<br>
&gt; -pkg core_kernel customtop.top<br>
&gt;<br>
&gt; (At the time I ran this, I had bap package&#39;s _oasis updated with t=
he<br>
&gt; appropriate compile BuildDepends so that it would link mylibrary too)<=
br>
&gt;<br>
&gt; and I had the let () =3D Utop_main.main ();; in &quot;<a href=3D"http:=
//utopmain.ml" target=3D"_blank">utopmain.ml</a>&quot; and customary<br>
&gt; customtop.mltop containing just &quot;Utopmain&quot;. I got:<br>
&gt;<br>
&gt; (Unbound value &lt;everything I need *and* that&#39;s contained in myl=
ibrary which<br>
&gt; is specified in -pkg!&gt;)<br>
&gt;<br>
&gt; I don&#39;t know what else to do besides ship code that is watered dow=
n without<br>
&gt; an interactive component. :/<br>
<br>
<br>
<br>
</div></div><span class=3D"HOEnZb"><font color=3D"#888888">--<br>
Jeremie<br>
</font></span></blockquote></div><br></div>

--047d7b5d483cf30de90511a94660--
